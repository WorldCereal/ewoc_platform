# Deploy log stack WorldCereal


## Purpose :

Deploy and configure the stack that handle the logging system of the worldcereal plateform.
All this items are located in the **logging** namespace.
The logging system repose on following software to store logs. 

- First, fluent-bit pods are placed on each node and send the logs to a kafka topic.
- The kafka topics keeps the events until a consumer come to read them.
- Graylog is the consumer and use kafka to retrieve events and store them in his elasticsearch DB.

![logging architecture](index.jpeg)

## Steps :
- Install Kafka
- Install Fluent-bit
- Install Graylog stack

### Install Kafka

#### Steps

Execute the following commands:
`make kafka`

The following topic should be created.
- **preprocessing.logs** 
- **keycloak.logs**
- **system.logs**

For now, the topic retention is only set to one day.

If you wish to add topic you can modify the values file and add your topics by using the following command as exemple :

`kubectl exec -n logging kafka-0 -c kafka -- kafka-topics.sh --bootstrap-server kafka.logging.svc.cluster.local:9092 --create --topic preprocessing.logs --partitions=3 --replication-factor=3 --config cleanup.policy=delete --config retention.ms=604800000 --config retention.bytes="-1"`

### Install Fluent-bit

#### Steps
Execute the following commands :
`make fluentbit`
This will deploy as deamonset on each node, one instance of fluent-bit wich is supposed to transmit all the logs collected to Kafka topics.

**Be carefull the rules syntax is tricky, respect the current format in order to avoid issues**

### Install Graylog stack
The graylog stack depends on 3 elements to works properly.
- The Graylog application.
- MongoDB to store Graylog configuration.
- Elasticsearch to store events logs.

### Install ElasticSearch

#### Steps
Execute the following commands :
`make elasticsearch`

### Install MongoDB
Deploy MongoDB.

#### Steps
Execute the following commands :
`make mongo`

This chart create one user graylog.
The password to access database is generated by `sys-init.sh` and stored as a secret with rhe right connection string.

### Install Graylog

#### Steps
Execute the following commands :
`make graylog`

Graylog is pre-initialized with a content packs that install all needed objects.


