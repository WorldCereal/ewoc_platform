# Deploy Reference Data Module (RDM)

## Requirements
- Access to kubectl
- Client rdm is created in keycloak and well configured
- Get the Client secret generated by keycloak
- Kong is up and running
- ```export-env.sh``` is sourced

## Deploy
To deploy this application get the code from https://github.com/WorldCereal/ewoc_rdm_deploy
All topics related to ingress and kong are handled by the make file in this repository.

Follow the following steps: 

1. Create namespace rdm. ```kubectl create ns rdm```

2. Create the harborcs that contains the credentials to access the harbor repository.
3. Exec ```kubectl apply -f pvc.yaml -n rdm``` and ```kubectl apply -f restapi-pvc.yaml -n rdm -n rdm```
**Don't forget to add the nodeSelector to restrict the domain of execution of the deployed pods**

4. Deploy the 3 instances of databases by running :
    - ```helm install rdm bitnami/postgresql --version 10.9.4 --values values.yaml -n rdm```
    - ```helm install rdm-cdb bitnami/postgresql --version 10.9.4 --values values.yaml -n rdm```
    - ```helm install rdm-rdb bitnami/postgresql --version 10.9.4 --values values.yaml -n rdm```

5. Execute the following job and wait until complete execution : ```kubectl apply -f rdmDbMigrate\job.yaml -n rdm ```

6. Execute the following job and wait until complete execution : ```kubectl apply -f rdmRefDbUpdate\job.yaml -n rdm ```

7. Change the configuration of rdmui.values to make it match with your domain name, https etc..
**Don't forget to add the nodeSelector to restrict the domain of execution of the deployed pods**

8. Deploy the webserver application by running : ```helm install rdmui bitnami/nginx --values rdmui/values.yaml -n rdm```

9. Deploy the pgadmin application (Change credentials in values.yaml before any deployment)
```
# add heml repo
helm repo add runix https://helm.runix.net

# add pgadmin
helm install pgadmin runix/pgadmin4 -f pgadmin/values.yaml -n rdm
```

10. If needed change values in ```rdm-ingress/ingress.yaml``` 

11. Protect the route with kong by running the following command (change url and client secret according the env in export-env.sh and source this file). This makefile is going to create ingress for rdm, rdmapi and pgadmin and create the link with the kong OIDC plugin to protect the route with keycloak SSO.
```
make kong
```
**NB: if you change the ingress name, change the kong endpoint because the route name is build from the ingress name**

12. Check that all you application are protected by the SSO.

## Update dataset

Everytime that the dataset needs to be updated you need to update 
the boolean value through the pgadmin application for the datasets that needs to be imported.

Then on the cluster, you have to delete old job and relaunch new one to load dataset in the databases.
```kubectl delete -n rdm job rdm-refUpdate(complete the name)```
```kubectl apply -f jobs.yaml -n rdm```
At the end of the job the data should be available in rdm application  




